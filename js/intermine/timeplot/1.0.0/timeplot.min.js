var DEFAULT_MINEURL="http://rumenmine-dev.ibers.aber.ac.uk/rumenmine-dev",DEFAULT_ID="p15539",DEFAULT_SVG="tchart",DEFAULT_TYPE="Gene",DEFAULT_REPLICATE=3;"undefined"==typeof mineUrl&&(mineUrl=DEFAULT_MINEURL),"undefined"==typeof queryId&&(queryId=DEFAULT_ID),"undefined"==typeof svgId&&(svgId=DEFAULT_SVG),"undefined"==typeof type&&(type=DEFAULT_TYPE),"undefined"==typeof replicatesNr&&(replicatesNr=DEFAULT_REPLICATE);var constraintOp="=",constraintPath="primaryIdentifier";"undefined"!=typeof listName&&(queryId=listName,constraintOp="IN",constraintPath=type),console.log(type+": "+svgId+" "+mineUrl+" "+queryId+" ("+constraintOp+" "+constraintPath+")");var query={from:type,select:["primaryIdentifier","symbol","RNASeqExpressions.expressionLevel","RNASeqExpressions.unit","RNASeqExpressions.experiment.SRAaccession","RNASeqExpressions.experiment.timePoint","RNASeqExpressions.experiment.tissue"],orderBy:[{path:"primaryIdentifier",direction:"ASC"},{path:type+".RNASeqExpressions.experiment.timePoint",direction:"ASC"},{path:type+".RNASeqExpressions.experiment.tissue",direction:"ASC"}],where:[{path:constraintPath,op:constraintOp,value:queryId,code:"A"}]},GPORTAL="portal.do?class="+type+"&externalids=",EPORTAL="portal.do?class=RnaseqExperiment&externalids=",svg=d3.select("#"+svgId),colors=d3.scale.category20(),margin={top:40,right:180,bottom:30,left:60},width=parseInt(svg.style("width")),x=null,xAxis=null,max=null,barHeight=10,render=function(){var t=width-margin.right,e=t/(max=d3.max(data,function(t){return+t[2]})),r=(data.length-1)/replicatesNr;console.log("WWW "+width+" MAX: "+max+" -- "+r),x=d3.scale.linear().domain([0,d3.max(data,function(t){return t[2]})]).range([0,t]),xAxis=d3.svg.axis().scale(x).orient("bottom"),svg.attr("height",0),data.length>0&&max>0&&(head=svg.append("foreignObject").attr("class","myheader").attr("x",0).attr("y",0).attr("width",width).attr("height",20).append("xhtml:body").html('<h3 class="goog"> '+r+" Digestion Time Points </h3>             <p> <p>"),svg.attr("height",margin.top+(barHeight*(data.length+r)+margin.bottom)));var n=svg.selectAll("g").data(data);n.enter().append("g").attr("class","proteinbar").attr("transform",function(t,e){return"translate("+margin.left+","+(margin.top+(e+Math.ceil(e/3))*barHeight)+")"}),n.append("a").on("mouseover",function(t,e){d3.select(this).attr({"xlink:href":mineUrl+EPORTAL+t[4]}).attr({"xlink:title":t[0]+": "+t[5]+" "+t[6]+" -> "+t[2]+" "+t[3]})}).append("rect").attr("data-legend",function(t){return t[6]}).attr("width",function(t){return t[2]*e}).attr("height",barHeight-1).style("fill",function(t,e){return colors(t[6])}),n.append("a").on("mouseover",function(t){d3.select(this).attr({"xlink:href":mineUrl+EPORTAL+t[4]}).attr({"xlink:title":t[0]+": "+t[5]+" "+t[6]+" -> "+t[2]+" "+t[3]})}).append("text").attr("class","toptip").attr("x",function(t){return Math.max(t[2]*e-25,0)}).attr("y",barHeight/2).attr("dy",".35em").attr("font-size",1.2*barHeight+"px").text(function(t){return t[2]}),n.append("a").on("mouseover",function(t){d3.select(this).attr({"xlink:href":mineUrl+EPORTAL+t[4]})}).append("text").attr("x",-50).attr("y",barHeight/2).attr("dy",".35em").attr("font-size",1.2*barHeight+"px").text(function(t,e){if(0==e||e%3==2)return t[5]}),svg.append("g").attr("class","x axis").attr("transform",function(t,e){return"translate("+margin.left+","+(margin.top+barHeight*(data.length+r)+5)+")"}).call(xAxis),svg.append("rect").attr("class","boundingbox").attr("x",0).attr("y",margin.top-5).attr("height",10+barHeight*(data.length+r)).attr("width",width-15).style("stroke","grey").style("fill","none").style("stroke-width",1),svg.append("g").attr("class","legend").attr("transform","translate("+(margin.left+max*e+2*barHeight)+","+2*margin.top+")").style("stroke","black").style("font-size","12px").style("fill","none").style("stroke-width",.8).call(d3.legend)},rescale=function(){var t=parseInt(svg.style("width")),e=t-margin.right,r=e/max;x.range([0,e]);var n=svg.selectAll(".proteinbar").data(data);n.attr("transform",function(t,e){return"translate("+margin.left+","+(margin.top+(e+Math.ceil(e/3))*barHeight)+")"}),n.select("rect").attr("width",function(t){return r*t[2]}).attr("height",barHeight-1).style("fill",function(t,e){return colors(t[6])}),n.select(".toptip").attr("x",function(t){return Math.max(t[2]*r-25,0)});svg.select(".legend").attr("transform","translate("+(margin.left+max*r+2*barHeight)+","+2*margin.top+")"),svg.select(".boundingbox").attr("width",t-15);xAxis.scale(x),svg.select(".x.axis").call(xAxis),head=svg.select(".myheader").attr("width",t)},myService=null;(myService="undefined"==typeof token||null===token?new imjs.Service({root:mineUrl+"service/"}):new imjs.Service({root:mineUrl,token:token})).rows(query).then(function(t){data=t,render()}),d3.select(window).on("resize",rescale),d3.legend=function(t){return t.each(function(){var t=d3.select(this),e={},r=d3.select(t.property("nearestViewportElement")),n=t.attr("data-style-padding")||5,a=t.selectAll(".legend-box").data([!0]),i=t.selectAll(".legend-items").data([!0]);a.enter().append("rect").classed("legend-box",!0),i.enter().append("g").classed("legend-items",!0),r.selectAll("[data-legend]").each(function(){var t=d3.select(this);e[t.attr("data-legend")]={pos:t.attr("data-legend-pos")||this.getBBox().y,color:void 0!=t.attr("data-legend-color")?t.attr("data-legend-color"):"none"!=t.style("fill")?t.style("fill"):t.style("stroke")}}),e=d3.entries(e).sort(function(t,e){return t.value.pos-e.value.pos}),i.selectAll("text").data(e,function(t){return t.key}).call(function(t){t.enter().append("text")}).call(function(t){t.exit().remove()}).attr("y",function(t,e){return e+"em"}).attr("x","1em").text(function(t){return t.key}),i.selectAll("circle").data(e,function(t){return t.key}).call(function(t){t.enter().append("circle")}).call(function(t){t.exit().remove()}).attr("cy",function(t,e){return e-.25+"em"}).attr("cx",0).attr("r","0.4em").style("fill",function(t){return console.log(t.value.color),t.value.color});var s=i[0][0].getBBox();a.attr("x",s.x-n).attr("y",s.y-n).attr("height",s.height+2*n).attr("width",s.width+2*n)}),t};